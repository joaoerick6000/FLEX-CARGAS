{% extends "base.html" %}

{% block title %}Nota #{{ nota.id }}{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Detalhes da Nota #{{ nota.id }}</h2>
    <div class="nota-info">
        <p><strong>Tipo:</strong> {{ 'À Vista' if nota.tipo == 'avista' else 'Anotação' }}</p>
        <p><strong>Data:</strong> {{ nota.data.strftime('%d/%m/%Y %H:%M') }}</p>
        <p><strong>Cliente:</strong> {{ nota.cliente.nome if nota.cliente else 'N/A' }}</p>
    </div>
</div>

<div class="table-container">
    <h3>Itens da Nota</h3>
    <form action="{{ url_for('editar_nota', nota_id=nota.id) }}" method="POST" id="form-editar-nota">
        <table>
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Quantidade</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for lancamento in lancamentos %}
                <tr>
                    <td>{{ lancamento.produto.nome }} ({{ lancamento.produto.codigo }})</td>
                    <td><input type="number" name="qtd_{{ lancamento.id }}" value="{{ lancamento.quantidade }}" min="0"></td>
                    <td><button type="button" class="btn-excluir" onclick="removerItemForm(this)">Remover</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if nota.tipo == 'anotacao' %}
        <div class="form-section">
            <h4>Mudar Cliente</h4>
            <select name="cliente_id">
                <option value="">{{ nota.cliente.nome }} (Atual)</option>
                {% for cliente_opt in clientes %}
                <option value="{{ cliente_opt.id }}">{{ cliente_opt.nome }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="form-section" id="adicionar-produto-section">
            <h4>Adicionar Novo Produto</h4>
            <div class="form-row">
                <input type="text" placeholder="Código ou Nome do Produto" class="input-produto-add">
                <select name="novo_produto_id" class="select-produto-add"></select>
                <input type="number" name="nova_quantidade" placeholder="Qtd" min="1" value="1">
            </div>
            <button type="button" class="btn-adicionar-item" onclick="adicionarNovoItem()">Adicionar Novo Item</button>
        </div>
        
        <button type="submit" class="btn-salvar">Salvar Alterações</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        setupSearchAdd();
    });

    function removerItemForm(button) {
        if (confirm('Deseja realmente remover este item?')) {
            const row = button.closest('tr');
            row.remove();
        }
    }

    function setupSearchAdd() {
        const searchInput = document.querySelector('.input-produto-add');
        const selectElement = document.querySelector('.select-produto-add');
        let searchTimeout;

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = searchInput.value;
                if (query.length > 1) {
                    fetch(`/buscar_produto/${query}`)
                        .then(response => response.json())
                        .then(data => {
                            selectElement.innerHTML = '';
                            if (data.length > 0) {
                                data.forEach(p => {
                                    const option = document.createElement('option');
                                    option.value = p.id;
                                    option.textContent = `${p.nome} (${p.codigo})`;
                                    selectElement.appendChild(option);
                                });
                            } else {
                                selectElement.innerHTML = '<option value="">Nenhum produto encontrado</option>';
                            }
                        });
                } else {
                    selectElement.innerHTML = '';
                }
            }, 300);
        });
    }

    function adicionarNovoItem() {
        const select = document.querySelector('.select-produto-add');
        const quantidadeInput = document.querySelector('input[name="nova_quantidade"]');
        const tbody = document.querySelector('#form-editar-nota tbody');

        const produtoId = select.value;
        const quantidade = quantidadeInput.value;
        const produtoNome = select.options[select.selectedIndex].textContent;

        if (produtoId && quantidade > 0) {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${produtoNome}</td>
                <td><input type="hidden" name="novo_produto_id" value="${produtoId}"><input type="number" name="nova_quantidade" value="${quantidade}" min="1"></td>
                <td><button type="button" class="btn-excluir" onclick="removerItemForm(this)">Remover</button></td>
            `;
            tbody.appendChild(newRow);

            // Limpa os campos
            document.querySelector('.input-produto-add').value = '';
            select.innerHTML = '';
            quantidadeInput.value = '1';
        } else {
            alert('Selecione um produto e uma quantidade válida.');
        }
    }
</script>
{% endblock %}